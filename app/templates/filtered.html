{% extends "base.html" %}

{% block title %}Filtered Data{% endblock %}

{% block content %}
<h2>Filtered Data Visualizations</h2>

{% if uploaded_file %}
<div class="uploaded-file">
    <strong>Currently Uploaded File:</strong> {{ uploaded_file }}
</div>
{% endif %}

<div class="download-section">
    <h2>Download Filtered CSV</h2>
    <button onclick="window.location.href='{{ url_for('filtered.download_filtered_summary') }}'">
        <span class="material-icons">download</span> Download Filtered CSV
    </button>
</div>

<div class="visualization-sections">
    <div class="visualization-section">
        <h3>Quantity</h3>
        <div class="button-group">
            <button onclick="fetchFilteredVisualization('Total Quantity', 'day')">
                <span class="material-icons">calendar_today</span> Daily
            </button>
            <button onclick="fetchFilteredVisualization('Total Quantity', 'week')">
                <span class="material-icons">calendar_today</span> Weekly
            </button>
            <button onclick="fetchFilteredVisualization('Total Quantity', 'month')">
                <span class="material-icons">calendar_today</span> Monthly
            </button>
            <button onclick="fetchFilteredVisualization('Total Quantity', 'year')">
                <span class="material-icons">calendar_today</span> Yearly
            </button>
        </div>
    </div>
    <div class="visualization-section">
        <h3>Amount</h3>
        <div class="button-group">
            <button onclick="fetchFilteredVisualization('Total Amount', 'day')">
                <span class="material-icons">attach_money</span> Daily
            </button>
            <button onclick="fetchFilteredVisualization('Total Amount', 'week')">
                <span class="material-icons">attach_money</span> Weekly
            </button>
            <button onclick="fetchFilteredVisualization('Total Amount', 'month')">
                <span class="material-icons">attach_money</span> Monthly
            </button>
            <button onclick="fetchFilteredVisualization('Total Amount', 'year')">
                <span class="material-icons">attach_money</span> Yearly
            </button>
        </div>
    </div>
</div>

<div class="visualization-sections">
    <div class="visualization-section">
        <h3>Sales by Product (Quantity)</h3>
        <div class="button-group">
            <button onclick="fetchFilteredVisualizationByProduct('Total Quantity', 'day')">
                <span class="material-icons">calendar_today</span> Daily
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Quantity', 'week')">
                <span class="material-icons">calendar_today</span> Weekly
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Quantity', 'month')">
                <span class="material-icons">calendar_today</span> Monthly
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Quantity', 'year')">
                <span class="material-icons">calendar_today</span> Yearly
            </button>
        </div>
    </div>
    <div class="visualization-section">
        <h3>Sales by Product (Amount)</h3>
        <div class="button-group">
            <button onclick="fetchFilteredVisualizationByProduct('Total Amount', 'day')">
                <span class="material-icons">attach_money</span> Daily
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Amount', 'week')">
                <span class="material-icons">attach_money</span> Weekly
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Amount', 'month')">
                <span class="material-icons">attach_money</span> Monthly
            </button>
            <button onclick="fetchFilteredVisualizationByProduct('Total Amount', 'year')">
                <span class="material-icons">attach_money</span> Yearly
            </button>
        </div>
    </div>
</div>

<div class="visualization-section">
    <h3>Shipping Methods</h3>
    <button onclick="fetchFilteredShippingMethods()">
        <span class="material-icons">local_shipping</span> View Shipping Methods
    </button>
</div>

<div class="visualization-section">
    <h3>Categories</h3>
    <button onclick="fetchFilteredCategories()">
        <span class="material-icons">category</span> View Categories
    </button>
</div>

<div id="filtered-visualization" class="visualization-container"></div>

<script>
    async function fetchFilteredVisualization(type, period) {
        try {
            const response = await fetch(`/api/filtered_visualization?type=${type}&period=${period}`);
            const data = await response.json();

            const trace = {
                x: data.x,
                y: data.y,
                type: 'bar'  // or 'line', depending on your preference
            };

            const layout = {
                title: `${type} by ${period} (Filtered)`
            };

            Plotly.newPlot('filtered-visualization', [trace], layout);
        } catch (error) {
            console.error('Error fetching filtered visualization data:', error);
        }
    }

    async function fetchFilteredVisualizationByProduct(type, period) {
        try {
            const response = await fetch(`/api/filtered_visualization_by_product?type=${type}&period=${period}`);
            const data = await response.json();

            const traces = Object.keys(data.data).map(product => ({
                x: data.x,
                y: data.data[product],
                name: product,
                type: 'bar'
            }));

            const layout = {
                title: `Sales by Product (${type}) - ${period} (Filtered)`,
                barmode: 'stack'
            };

            Plotly.newPlot('filtered-visualization', traces, layout);
        } catch (error) {
            console.error('Error fetching filtered visualization data:', error);
        }
    }

    async function fetchFilteredShippingMethods() {
        try {
            const response = await fetch('/api/filtered_shipping_methods');
            const data = await response.json();

            const trace = {
                labels: data.labels,
                values: data.values,
                type: 'pie'
            };

            const layout = {
                title: 'Filtered Shipping Methods Distribution'
            };

            Plotly.newPlot('filtered-visualization', [trace], layout);
        } catch (error) {
            console.error('Error fetching filtered shipping methods data:', error);
        }
    }

    async function fetchFilteredCategories() {
        try {
            const response = await fetch('/api/filtered_categories');
            const data = await response.json();

            const trace = {
                labels: data.labels,
                values: data.values,
                type: 'pie'
            };

            const layout = {
                title: 'Filtered Categories Distribution'
            };

            Plotly.newPlot('filtered-visualization', [trace], layout);
        } catch (error) {
            console.error('Error fetching filtered categories data:', error);
        }
    }
</script>
{% endblock %}
